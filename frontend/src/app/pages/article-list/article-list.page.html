<div class="mx-auto max-w-3xl">
  <div class="mb-6 flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-900">Articles</h1>
    @if (showForm()) {
      <button (click)="toggleForm()"
              class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50">
        Cancel
      </button>
    } @else {
      <button (click)="toggleForm()"
              class="rounded-md bg-teal-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-teal-500">
        New article
      </button>
    }
  </div>

  @if (showForm()) {
    <div class="mb-6 rounded-lg border border-gray-200 bg-white p-6">
      <h2 class="mb-4 text-lg font-semibold text-gray-900">New article</h2>
      <app-article-form
        [serverErrors]="serverErrors()"
        [submitting]="submitting()"
        (submitted)="onArticleSubmit($event)" />
    </div>
  }

  @defer (on idle) {
    @if (engagementStats(); as stats) {
      <div class="mb-6 rounded-lg border border-gray-200 bg-white p-4">
        <div class="flex items-start gap-6">
          <div class="flex shrink-0 gap-3">
            <div class="rounded-md bg-emerald-50 px-3 py-2 text-center">
              <p class="text-lg font-bold text-teal-700">{{ stats.total_articles }}</p>
              <p class="text-xs text-teal-600">Articles</p>
            </div>
            <div class="rounded-md bg-emerald-50 px-3 py-2 text-center">
              <p class="text-lg font-bold text-teal-700">{{ stats.total_comments }}</p>
              <p class="text-xs text-teal-600">Comments</p>
            </div>
          </div>
          @if (stats.most_commented.length > 0) {
            <div class="min-w-0 flex-1">
              <h3 class="mb-1 text-xs font-semibold uppercase tracking-wide text-gray-400">Most commented</h3>
              <ul class="space-y-0.5">
                @for (article of stats.most_commented; track article.id) {
                  <li>
                    <a [routerLink]="['/articles', article.id]"
                       class="flex items-center justify-between rounded px-2 py-1 text-sm hover:bg-gray-50">
                      <span class="truncate text-gray-700">{{ article.title }}</span>
                      <span class="ml-2 shrink-0 rounded-full bg-emerald-50 px-1.5 py-0.5 text-xs font-medium text-teal-700">{{ article.comments_count }}</span>
                    </a>
                  </li>
                }
              </ul>
            </div>
          }
        </div>
      </div>
    }
  } @placeholder {
    <div class="mb-6 h-20 animate-pulse rounded-lg bg-gray-100"></div>
  }

  @if (articles(); as articles) {
    <div class="space-y-3">
      @for (article of articles; track article.id) {
        <app-article-card [article]="article" />
      } @empty {
        <div class="rounded-lg border-2 border-dashed border-gray-300 px-6 py-12 text-center">
          <div class="text-4xl">&#9997;&#65039;</div>
          <h3 class="mt-3 text-sm font-semibold text-gray-900">No articles yet</h3>
          <p class="mt-1 text-sm text-gray-500">Get the conversation started.</p>
          <button (click)="toggleForm()"
                  class="mt-4 rounded-md bg-teal-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-teal-500">
            Write the first article
          </button>
        </div>
      }
    </div>
  } @else {
    <div class="space-y-3">
      <div class="h-20 animate-pulse rounded-lg bg-gray-100"></div>
      <div class="h-20 animate-pulse rounded-lg bg-gray-100"></div>
      <div class="h-20 animate-pulse rounded-lg bg-gray-100"></div>
    </div>
  }
</div>
